<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Superb IT Asset Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@zxing/library@0.19.2/umd/index.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --neon-blue: #00f0ff;
      --neon-pink: #ff00e6;
      --neon-purple: #7b00ff;
      --dark-bg: #0a0e1a;
      --card-bg: #1a2333;
      --glow-accent: #00f0ff88;
      --text-glow: #ffffffcc;
      --holo-gradient: linear-gradient(135deg, #00f0ff22 0%, #ff00e622 50%, #7b00ff22 100%);
      --card-glow: 0 0 10px #00f0ff55, 0 0 20px #ff00e644, 0 0 30px #7b00ff33;
      --button-glow: 0 0 8px #00f0ff99, 0 0 15px #ff00e666;
      --reserved-color: #ff9100;
      --quantity-color: #00ff88;
    }
    body.dark {
      --neon-blue: #00e4ff;
      --neon-pink: #ff33f0;
      --neon-purple: #8b33ff;
      --dark-bg: #0e1424;
      --card-bg: #222b40;
      --glow-accent: #00e4ff88;
      --text-glow: #ffffffdd;
      --holo-gradient: linear-gradient(135deg, #00e4ff22 0%, #ff33f022 50%, #8b33ff22 100%);
      --card-glow: 0 0 12px #00e4ff66, 0 0 22px #ff33f055, 0 0 32px #8b33ff44;
      --button-glow: 0 0 10px #00e4ffaa, 0 0 18px #ff33f077;
      --reserved-color: #ffa733;
      --quantity-color: #33ff99;
    }
    html, body {
      min-height: 100vh;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background: var(--dark-bg);
      font-family: 'Roboto Mono', monospace;
      color: var(--text-glow);
      -webkit-tap-highlight-color: transparent;
      overflow-x: hidden;
      background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Crect fill="%23001a33" width="100" height="100"/%3Cpath fill="%2300f0ff22" d="M0,0 L100,100 M100,0 L0,100" stroke="%2300f0ff33" stroke-width="0.5"/%3C/svg%3E');
      background-size: 100px;
      animation: subtle-pulse 10s infinite ease-in-out;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      height: 100vh;
      width: 100vw;
      perspective: 1000px;
    }
    header {
      background: var(--card-bg);
      box-shadow: var(--card-glow);
      border-bottom: 2px solid var(--neon-blue);
      padding: 20px 0 12px 0;
      text-align: center;
      font-family: 'Orbitron', monospace;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-pink);
      transform: translateZ(20px);
      animation: neon-flicker 5s infinite;
    }
    .dark-toggle-btn {
      position: absolute;
      right: 15px; top: 15px;
      background: linear-gradient(90deg, var(--neon-purple), var(--neon-blue));
      color: #fff;
      font-size: 1.5rem;
      border-radius: 50%;
      width: 48px; height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--neon-blue);
      cursor: pointer;
      box-shadow: var(--button-glow);
      z-index: 200;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .dark-toggle-btn:hover {
      transform: scale(1.1) translateZ(10px);
      box-shadow: 0 0 15px var(--neon-blue), 0 0 25px var(--neon-purple);
    }
    .search-bar {
      display: flex;
      gap: 12px;
      background: var(--card-bg);
      padding: 15px;
      position: sticky;
      top: 0;
      z-index: 20;
      border-bottom: 2px solid var(--neon-blue);
      align-items: center;
      flex-wrap: wrap;
      box-shadow: var(--card-glow);
      transform: translateZ(15px);
    }
    body.dark .search-bar {
      border-bottom: 2px solid var(--neon-purple);
    }
    .search-bar input, .search-bar select {
      font-size: 1.1rem;
      padding: 12px;
      border: 2px solid var(--neon-blue);
      border-radius: 10px;
      outline: none;
      flex: 1;
      min-width: 130px;
      background: #0a0e1a88;
      color: var(--text-glow);
      box-shadow: inset 0 0 8px var(--glow-accent);
      transition: all 0.3s ease;
      font-family: 'Roboto Mono', monospace;
    }
    .search-bar input:focus, .search-bar select:focus {
      box-shadow: 0 0 15px var(--neon-blue), inset 0 0 10px var(--neon-pink);
      border-color: var(--neon-pink);
      transform: translateZ(5px);
    }
    body.dark .search-bar input, body.dark .search-bar select {
      background: #0e142488;
      border-color: var(--neon-purple);
    }
    .search-bar .btn, .search-bar .download-pdf-btn {
      flex: 0 0 auto;
    }
    .download-pdf-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-left: 10px;
      font-size: 1.8rem;
      color: var(--neon-blue);
      transition: all 0.2s;
      padding: 5px;
    }
    .download-pdf-btn:hover {
      color: var(--neon-pink);
      text-shadow: 0 0 10px var(--neon-pink);
      transform: translateZ(10px);
    }
    .badge {
      display: inline-block;
      min-width: 24px;
      padding: 4px 10px;
      font-size: 14px;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
      color: #fff;
      border-radius: 14px;
      margin-left: 8px;
      font-weight: 600;
      box-shadow: 0 0 8px var(--glow-accent);
      transform: translateZ(5px);
    }
    body.dark .badge {
      background: linear-gradient(90deg, var(--neon-purple), var(--neon-blue));
    }
    .faulty-badge {
      background: linear-gradient(90deg, #ff3333, #cc0000) !important;
      box-shadow: 0 0 10px #ff3333aa !important;
    }
    .reserved-badge {
      background: linear-gradient(90deg, var(--reserved-color), #cc7000) !important;
      box-shadow: 0 0 10px var(--reserved-color) !important;
    }
    .quantity-badge {
      background: linear-gradient(90deg, var(--quantity-color), #00cc66) !important;
      box-shadow: 0 0 10px var(--quantity-color) !important;
    }
    .asset-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1 1 auto;
      overflow-y: auto;
      background: transparent;
    }
    .asset-card {
      background: var(--card-bg);
      margin: 15px;
      border-radius: 12px;
      box-shadow: var(--card-glow);
      border: 1px solid var(--neon-blue);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
      transform: translateZ(10px);
    }
    .asset-card:hover {
      transform: translateZ(20px) scale(1.02);
      box-shadow: 0 0 20px var(--neon-blue), 0 0 30px var(--neon-pink);
    }
    body.dark .asset-card {
      border: 1px solid var(--neon-purple);
    }
    .asset-card-header {
      font-weight: 600;
      font-size: 1.2rem;
      padding: 16px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
      color: var(--text-glow);
      text-shadow: 0 0 5px var(--neon-blue);
    }
    .asset-card .expand-icon {
      margin-left: 10px;
      font-size: 1.5rem;
      color: var(--neon-pink);
      transition: transform 0.3s ease;
    }
    .asset-card.open .expand-icon {
      transform: rotate(90deg);
    }
    .asset-card.open {
      box-shadow: 0 0 25px var(--neon-blue), 0 0 35px var(--neon-purple);
      transform: translateZ(15px);
    }
    .asset-details {
      display: none;
      padding: 12px 24px 16px;
      font-size: 1.05rem;
      animation: holo-fade 0.5s ease;
      color: var(--text-glow);
      background: var(--holo-gradient);
      border-top: 1px solid var(--neon-blue);
    }
    .asset-card.open .asset-details {
      display: block;
    }
    .asset-details label {
      font-weight: 600;
      color: var(--neon-pink);
      text-shadow: 0 0 5px var(--neon-pink);
    }
    .asset-details .chip {
      display: inline-block;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
      color: #fff;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      padding: 4px 10px;
      margin-right: 8px;
      box-shadow: 0 0 8px var(--glow-accent);
    }
    .asset-actions {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .btn {
      border: none;
      outline: none;
      font-size: 1.15rem;
      border-radius: 10px;
      font-weight: 600;
      padding: 12px 25px;
      cursor: pointer;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
      color: #fff;
      box-shadow: var(--button-glow);
      transition: all 0.3s ease;
      font-family: 'Roboto Mono', monospace;
      transform: translateZ(5px);
    }
    .btn:hover {
      transform: translateZ(10px) scale(1.05);
      box-shadow: 0 0 15px var(--neon-blue), 0 0 25px var(--neon-purple);
    }
    .btn.delete {
      background: linear-gradient(90deg, #ff3333, #cc0000);
      box-shadow: 0 0 10px #ff3333aa;
    }
    .btn.cancel {
      background: linear-gradient(90deg, #555, #333);
      color: var(--text-glow);
    }
    .btn.scan {
      background: linear-gradient(90deg, var(--quantity-color), var(--neon-blue));
      margin-left: 8px;
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: 0 0 10px var(--quantity-color);
    }
    .fab {
      position: fixed;
      right: 30px;
      bottom: 30px;
      z-index: 100;
      width: 70px;
      height: 70px;
      background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
      border-radius: 50%;
      box-shadow: var(--button-glow);
      font-size: 2.8rem;
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      transform: translateZ(15px);
    }
    .fab:hover {
      transform: translateZ(25px) scale(1.1);
      box-shadow: 0 0 20px var(--neon-blue), 0 0 30px var(--neon-pink);
    }
    #formModal, #typesModal {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 14, 26, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }
    #formModal.show, #typesModal.show {
      display: flex;
    }
    .form-card, .types-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 25px 20px;
      min-width: 90vw;
      max-width: 450px;
      box-shadow: var(--card-glow);
      color: var(--text-glow);
      animation: holo-fade 0.5s ease;
      transform: translateZ(20px);
      border: 2px solid var(--neon-purple);
    }
    .form-card form, .types-card form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .footer {
      text-align: center;
      margin: 15px 0;
      color: var(--neon-blue);
      font-size: 1.1rem;
      text-shadow: 0 0 8px var(--neon-blue);
    }
    body.dark .footer {
      color: var(--neon-purple);
    }
    @media (min-width: 700px) {
      .fab {
        width: 80px;
        height: 80px;
        font-size: 3rem;
        right: 50px;
        bottom: 50px;
      }
      .form-card, .types-card {
        min-width: 450px;
      }
      .search-bar {
        flex-wrap: nowrap;
      }
      .search-bar input, .search-bar select {
        min-width: auto;
        max-width: 200px;
      }
    }
    @keyframes neon-flicker {
      0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
        text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-pink);
      }
      20%, 24%, 55% {
        text-shadow: none;
      }
    }
    @keyframes holo-fade {
      from {
        opacity: 0;
        transform: translateY(20px) translateZ(0);
      }
      to {
        opacity: 1;
        transform: translateY(0) translateZ(20px);
      }
    }
    @keyframes subtle-pulse {
      0% { background-position: 0 0; }
      50% { background-position: 100px 100px; }
      100% { background-position: 0 0; }
    }
    #scanner-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 14, 26, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2500;
      flex-direction: column;
      animation: holo-fade 0.5s ease;
      backdrop-filter: blur(5px);
    }
    #scanner-container video {
      border-radius: 15px;
      max-width: 95vw;
      max-height: 60vh;
      box-shadow: 0 0 20px var(--neon-blue), 0 0 30px var(--neon-purple);
      border: 2px solid var(--neon-pink);
    }
    #scanner-close {
      background: linear-gradient(90deg, #ff3333, #cc0000);
      color: #fff;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      padding: 12px 40px;
      margin-top: 20px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 0 10px #ff3333aa;
      transition: all 0.2s;
      transform: translateZ(5px);
    }
    #scanner-close:hover {
      transform: translateZ(10px);
      box-shadow: 0 0 15px #ff3333cc;
    }
    #scanner-status {
      color: var(--text-glow);
      margin-top: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      text-shadow: 0 0 10px var(--neon-blue);
    }
    .quantity-input-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .quantity-input-group label {
      font-weight: 600;
      color: var(--neon-pink);
      text-shadow: 0 0 5px var(--neon-pink);
    }
    .quantity-input-group input {
      width: 90px;
      padding: 10px;
      text-align: center;
      background: #0a0e1a88;
      border: 2px solid var(--neon-blue);
      color: var(--text-glow);
      box-shadow: inset 0 0 8px var(--glow-accent);
    }
    .individual-items-list {
      list-style: none;
      padding-left: 0;
      max-height: 220px;
      overflow-y: auto;
      border-top: 1px solid var(--neon-blue);
      padding-top: 10px;
      margin-top: 8px;
    }
    .individual-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid var(--neon-blue);
      color: var(--text-glow);
    }
    .type-management {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }
    .type-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--neon-blue);
    }
    body.dark .type-item {
      border-bottom: 1px solid var(--neon-purple);
    }
    .type-actions {
      display: flex;
      gap: 6px;
    }
    .type-btn {
      padding: 6px 12px;
      font-size: 0.95rem;
      box-shadow: var(--button-glow);
    }
    .type-input {
      flex: 1;
      margin-right: 12px;
      background: #0a0e1a88;
      border: 2px solid var(--neon-blue);
      color: var(--text-glow);
      box-shadow: inset 0 0 8px var(--glow-accent);
      padding: 8px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    Superb IT Asset Manager
    <button class="dark-toggle-btn" id="darkModeBtn" title="Toggle dark mode">🌙</button>
  </header>
  <div class="search-bar">
    <input type="search" id="searchInput" placeholder="Search assets...">
    <div style="display: flex; align-items: center; flex: 1; min-width: 130px;">
      <select id="typeFilter"></select>
      <button class="btn" id="manageTypesBtn" style="margin-left: 6px; padding: 12px 14px;" title="Manage Asset Types">⚙️</button>
    </div>
    <select id="statusFilter">
      <option value="all">All Assets</option>
      <option value="faulty">Faulty Only</option>
      <option value="reserved">Reserved Only</option>
      <option value="both">Both Faulty & Reserved</option>
      <option value="neither">Neither Faulty nor Reserved</option>
    </select>
    <button class="btn" id="exportBtn" style="padding:12px 20px;">Export CSV</button>
    <button class="download-pdf-btn" id="pdfBtn" title="Download Type Quantities as PDF">
      &#128459;
    </button>
  </div>
  <ul class="asset-list" id="assetsBox"></ul>
  <button class="fab" id="addFab" title="Add Asset">+</button>
  <div class="footer">&copy; 2025 Superb Hyper. Data stored securely in JSONBin.</div>
  <div id="formModal"><div class="form-card" id="formCard"></div></div>
  <div id="typesModal"><div class="types-card" id="typesCard"></div></div>
  <script>
    // DARK MODE
    function setDarkMode(state) {
      if (state) {
        document.body.classList.add('dark');
        document.getElementById("darkModeBtn").textContent = "☀️";
        localStorage.setItem('superb_darkmode','1');
      } else {
        document.body.classList.remove('dark');
        document.getElementById("darkModeBtn").textContent = "🌙";
        localStorage.setItem('superb_darkmode','0');
      }
    }
    document.getElementById("darkModeBtn").onclick = function() {
      setDarkMode(!document.body.classList.contains('dark'));
    };
    if (localStorage.getItem('superb_darkmode') === '1') setDarkMode(true);
    
    // JSONBin Settings
    const JSONBIN_API = "https://api.jsonbin.io/v3/b/686e6c4d5f4bcf6c3afb1182";
    const JSONBIN_KEY = "$2a$10$BqM/s2f2kqZGoB5V14WtWOPOVO5/ccx/wZtBqmQsgeQqh6WMp42We";
    let ASSET_TYPES = [
      "Laptop", "Desktop", "Monitor", "Printer", "Router", "Switch", "Scanner",
      "Keyboard", "Mouse", "UPS", "Projector", "Tablet", "Phone", "Access Point",
      "Server", "Docking Station", "Webcam", "Headset", "Speaker", "External HDD/SSD",
      "Flash Drive", "Cables", "Adapter", "Other", "Tally"
    ];
    const AREA_OPTIONS = [
      "BULK", "ONLINE", "RETAIL", "KIOSK RETAIL", "KIOSK BULK", "SILVERS",
      "PRICING", "RECEIVING", "BARCODING", "DAMAGES", "OFFICE",
      "CASH OFFICE", "SPARE", "TESTING", "DUMPING", "STORAGE"
    ];
    let ALL_ASSETS = [];
    let CURRENT_TYPE = "All Types";
    
    // Function to group assets by Name
    function groupAssets(assets) {
        const groups = {};
        assets.forEach(asset => {
            const key = asset.Name || "<i>Unnamed Asset</i>";
            if (!groups[key]) {
                groups[key] = [];
            }
            groups[key].push(asset);
        });
        return groups;
    }
    
    // Helper function to find common values in a group
    function getCommonGroupValues(groupItems) {
        if (!groupItems || groupItems.length === 0) return {};
        const firstItem = groupItems[0];
        let commonValues = {
            Type: firstItem.Type,
            Area: firstItem.Area,
            Assigned: firstItem.Assigned,
            Notes: firstItem.Notes,
            Faulty: firstItem.Faulty,
            Reserved: firstItem.Reserved
        };
        for (let i = 1; i < groupItems.length; i++) {
            const item = groupItems[i];
            for (const key in commonValues) {
                if (commonValues[key] !== item[key]) {
                    commonValues[key] = undefined;
                }
            }
        }
        return commonValues;
    }
    
    function getTypeCounts() {
      const counts = {};
      for (const a of ALL_ASSETS) {
        if (!a.Type) continue;
        counts[a.Type] = (counts[a.Type] || 0) + 1;
      }
      return counts;
    }
    
    function populateTypeFilter() {
      const sel = document.getElementById("typeFilter");
      const typeCounts = getTypeCounts();
      let allTypes = [...new Set([
        ...ASSET_TYPES,
        ...ALL_ASSETS.map(a => a.Type).filter(Boolean)
      ])].sort();
      const total = ALL_ASSETS.length;
      sel.innerHTML = `<option value="All Types">All Types (${total})</option>` +
        allTypes.map(t =>
          `<option value="${t}">${t} (${typeCounts[t]||0})</option>`
        ).join('');
      sel.value = CURRENT_TYPE;
    }
    
    function renderAssets(search = "", type = "All Types", statusFilter = "all") {
      const box = document.getElementById("assetsBox");
      let filtered = ALL_ASSETS;
      
      if (search) {
        filtered = filtered.filter(a =>
          (a.Name + (a.Type||"") + (a.Serial||"") + (a.Area||"") + (a.Assigned||"") + (a.Notes||""))
            .toLowerCase().includes(search.toLowerCase())
        );
      }
      
      if (type && type !== "All Types") {
        filtered = filtered.filter(a => (a.Type||"").toLowerCase() === type.toLowerCase());
      }
      
      switch (statusFilter) {
        case "faulty":
          filtered = filtered.filter(a => a.Faulty === true);
          break;
        case "reserved":
          filtered = filtered.filter(a => a.Reserved === true);
          break;
        case "both":
          filtered = filtered.filter(a => a.Faulty === true && a.Reserved === true);
          break;
        case "neither":
          filtered = filtered.filter(a => a.Faulty !== true && a.Reserved !== true);
          break;
      }
      
      const assetGroups = groupAssets(filtered);
      const groupKeys = Object.keys(assetGroups).sort();
      
      if (groupKeys.length === 0) {
        box.innerHTML = `<div style="color:#888;margin:20px 0;text-align:center">No assets found.</div>`;
        return;
      }
      
      box.innerHTML = groupKeys.map(groupName => {
        const groupItems = assetGroups[groupName];
        const quantity = groupItems.length;
        const firstItem = groupItems[0];
        const isGroupOpen = firstItem.open;
        
        const faultyCount = groupItems.filter(item => item.Faulty === true).length;
        const reservedCount = groupItems.filter(item => item.Reserved === true).length;
        const normalCount = groupItems.filter(item => item.Faulty !== true && item.Reserved !== true).length;
        
        return `
        <li class="asset-card${isGroupOpen?" open":""}" data-name="${groupName}">
          <div class="asset-card-header">
            <span>${groupName}</span>
            <div>
              <span class="badge quantity-badge">${quantity}</span>
              ${faultyCount > 0 ? `<span class="badge faulty-badge">Faulty: ${faultyCount}</span>` : ''}
              ${reservedCount > 0 ? `<span class="badge reserved-badge">Reserved: ${reservedCount}</span>` : ''}
              ${normalCount > 0 ? `<span class="badge">Normal: ${normalCount}</span>` : ''}
            </div>
            <span class="expand-icon">&#9654;</span>
          </div>
          <div class="asset-details">
            <div><label>Type:</label> <span class="chip">${firstItem.Type || "-"}</span></div>
            <div><label>Faulty:</label> ${firstItem.Faulty ? 'Yes' : 'No'}</div>
            <div><label>Reserved:</label> ${firstItem.Reserved ? 'Yes' : 'No'}</div>
            <div><label>Serial:</label> ${firstItem.Serial || "-"} </div>
            <div><label>Area:</label> ${firstItem.Area || "-"} </div>
            <div><label>Assigned:</label> ${firstItem.Assigned || "-"} </div>
            <div><label>Notes:</label> ${firstItem.Notes || "-"} </div>
            <div><em>Quantity in group: ${quantity}</em></div>
            <div class="asset-actions">
              <button class="btn" onclick="editAssetGroup('${groupName}')">Edit Group</button>
              <button class="btn delete" onclick="deleteAssetGroup('${groupName}')">Delete Group</button>
            </div>
            <div style="margin-top: 15px;">
              <label>Individual Items:</label>
              <ul class="individual-items-list">
                ${groupItems.map((item, groupIndex) => {
                  const globalIndex = ALL_ASSETS.findIndex(a => a === item);
                  const serialDisplay = item.Serial ? ` (${item.Serial})` : '';
                  if (globalIndex === -1) {
                      console.error("Could not find global index for item:", item);
                      return `<li class="individual-item" style="color: red;">Error: Item not found</li>`;
                  }
                  return `
                    <li class="individual-item">
                      <span>Item ${groupIndex + 1}${serialDisplay}</span>
                      <button class="btn" style="padding: 6px 12px; font-size: 0.95rem;" onclick="editSingleAsset(${globalIndex})">Edit</button>
                    </li>
                  `;
                }).join('')}
              </ul>
            </div>
          </div>
        </li>
      `;
      }).join("");
      
      box.querySelectorAll('.asset-card-header').forEach(header => {
        header.onclick = function() {
          const card = header.closest('.asset-card');
          const groupName = card.getAttribute('data-name');
          const groupItems = assetGroups[groupName] || [];
          const isOpen = card.classList.contains('open');
          groupItems.forEach(item => item.open = !isOpen);
          card.classList.toggle('open');
        };
      });
    }
    
    async function fetchAssets() {
      try {
        let res = await fetch(JSONBIN_API + "/latest", {
          headers: { "X-Master-Key": JSONBIN_KEY }
        });
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        let data = await res.json();
        ALL_ASSETS = data.record || [];
        if (!ALL_ASSETS.length) {
          ALL_ASSETS = [{
            Name: "Sample Laptop",
            Type: "Laptop",
            Serial: "SN123456",
            Area: "Office",
            Assigned: "",
            Notes: "",
            Faulty: false,
            Reserved: false
          }];
        }
        populateTypeFilter();
        renderAssets(
          document.getElementById("searchInput").value,
          document.getElementById("typeFilter").value,
          document.getElementById("statusFilter").value
        );
      } catch (e) {
        document.getElementById("assetsBox").innerHTML = `<div style="color:#ff3333;margin:20px 0;text-align:center">Could not load data.<br>${e}</div>`;
      }
    }
    
    async function saveAsset(asset, editingIdx, quantity = 1) {
      try {
        let updated = [...ALL_ASSETS];
        const qty = Math.max(1, parseInt(quantity, 10) || 1);
        if (typeof editingIdx === "number") {
            updated[editingIdx] = asset;
        } else {
            for (let i = 0; i < qty; i++) {
                updated.push({...asset});
            }
        }
        let res = await fetch(JSONBIN_API, {
          method: "PUT",
          headers: { "Content-Type": "application/json", "X-Master-Key": JSONBIN_KEY },
          body: JSON.stringify(updated)
        });
        let result = await res.json();
        if (result && result.record) fetchAssets();
        else alert("Save failed: " + (result.message || JSON.stringify(result)));
      } catch (e) { alert("Save error: " + e); }
    }
    
    async function deleteAssetGroup(groupName) {
       if (!confirm(`Delete ALL assets named "${groupName}"?`)) return;
       let updated = ALL_ASSETS.filter(a => (a.Name || "<i>Unnamed Asset</i>") !== groupName);
       try {
         let res = await fetch(JSONBIN_API, {
           method: "PUT",
           headers: { "Content-Type": "application/json", "X-Master-Key": JSONBIN_KEY },
           body: JSON.stringify(updated)
         });
         let result = await res.json();
         if (result && result.record) fetchAssets();
         else alert("Delete failed: " + (result.message || JSON.stringify(result)));
       } catch (e) { alert("Delete error: " + e); }
    }
    
    function showGroupEditForm(groupName) {
        const groupItems = ALL_ASSETS.filter(a => (a.Name || "<i>Unnamed Asset</i>") === groupName);
        if (groupItems.length === 0) {
            alert("No items found in this group.");
            return;
        }
        const commonValues = getCommonGroupValues(groupItems);
        const itemCount = groupItems.length;
        const modal = document.getElementById("formModal");
        const formCard = document.getElementById("formCard");
        modal.classList.add("show");
        
        let formHTML = `
            <form id="groupEditForm" autocomplete="off">
                <h3 style="margin-top:0; text-align:center; text-shadow: 0 0 10px var(--neon-blue);">Edit Group: ${groupName}</h3>
                <p style="text-align:center; margin-top:0; margin-bottom:15px;"><em>Editing ${itemCount} item(s)</em></p>
                <label for="groupEditType" style="color: var(--neon-pink);">Type:</label>
                <select name="Type" id="groupEditType" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
                    <option value="">(No Change)</option>
                    ${ASSET_TYPES.map(t =>
                        `<option value="${t}" ${commonValues.Type === t ? "selected" : ""}>${t}</option>`
                    ).join("")}
                </select>
                <label for="groupEditArea" style="color: var(--neon-pink);">Area:</label>
                <select name="Area" id="groupEditArea" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
                    <option value="">(No Change)</option>
                    <option value="" disabled>Select Area</option>
                    ${AREA_OPTIONS.map(opt => `<option value="${opt}" ${commonValues.Area === opt ? "selected" : ""}>${opt}</option>`).join("")}
                </select>
                <label for="groupEditAssigned" style="color: var(--neon-pink);">Assigned To:</label>
                <input type="text" name="Assigned" id="groupEditAssigned" placeholder="Assigned To" value="${commonValues.Assigned || ''}" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
                <label for="groupEditNotes" style="color: var(--neon-pink);">Notes:</label>
                <textarea name="Notes" id="groupEditNotes" placeholder="Notes" style="min-height:48px; background: #0a0e1a88; border: 2px solid var(--neon-blue);">${commonValues.Notes || ''}</textarea>
                <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:10px;">
                    <label style="display:flex; align-items:center; color: var(--neon-pink);">
                        <input type="checkbox" name="Faulty" id="groupEditFaultyCheckbox" ${commonValues.Faulty === true ? "checked" : ""} style="margin-right:8px;">
                        Set Faulty Status for All
                    </label>
                    <select name="FaultyAction" id="groupEditFaultyAction" style="margin-left: 0px; margin-top: 5px; background: #0a0e1a88; border: 2px solid var(--neon-blue);">
                        <option value="nochange">No Change</option>
                        <option value="setTrue">Set to Faulty</option>
                        <option value="setFalse">Set to Not Faulty</option>
                    </select>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:10px;">
                    <label style="display:flex; align-items:center; color: var(--neon-pink);">
                        <input type="checkbox" name="Reserved" id="groupEditReservedCheckbox" ${commonValues.Reserved === true ? "checked" : ""} style="margin-right:8px;">
                        Set Reserved Status for All
                    </label>
                    <select name="ReservedAction" id="groupEditReservedAction" style="margin-left: 0px; margin-top: 5px; background: #0a0e1a88; border: 2px solid var(--neon-blue);">
                        <option value="nochange">No Change</option>
                        <option value="setTrue">Set to Reserved</option>
                        <option value="setFalse">Set to Not Reserved</option>
                    </select>
                </div>
                <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">
                    <button class="btn" type="submit" style="flex:1;">Update Group</button>
                    <button class="btn cancel" type="button" id="groupEditCancelBtn" style="flex:1;">Cancel</button>
                </div>
            </form>
        `;
        formCard.innerHTML = formHTML;
        
        document.getElementById("groupEditForm").onsubmit = function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const updates = Object.fromEntries(formData);
            
            const updatedAssets = [...ALL_ASSETS];
            const indicesToUpdate = updatedAssets.reduce((indices, asset, index) => {
                if ((asset.Name || "<i>Unnamed Asset</i>") === groupName) {
                    indices.push(index);
                }
                return indices;
            }, []);
            
            indicesToUpdate.forEach(idx => {
                if (updates.Type) updatedAssets[idx].Type = updates.Type;
                if (updates.Area) updatedAssets[idx].Area = updates.Area;
                if (updates.Assigned !== undefined) updatedAssets[idx].Assigned = updates.Assigned;
                if (updates.Notes !== undefined) updatedAssets[idx].Notes = updates.Notes;
                
                const faultyAction = updates.FaultyAction;
                if (faultyAction === "setTrue") {
                    updatedAssets[idx].Faulty = true;
                } else if (faultyAction === "setFalse") {
                    updatedAssets[idx].Faulty = false;
                }
                
                const reservedAction = updates.ReservedAction;
                if (reservedAction === "setTrue") {
                    updatedAssets[idx].Reserved = true;
                } else if (reservedAction === "setFalse") {
                    updatedAssets[idx].Reserved = false;
                }
            });
            
            saveUpdatedAssets(updatedAssets);
            modal.classList.remove("show");
        };
        
        document.getElementById("groupEditCancelBtn").onclick = function() {
            modal.classList.remove("show");
        };
    }
    
    async function saveUpdatedAssets(updatedAssetsArray) {
        try {
            let res = await fetch(JSONBIN_API, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": JSONBIN_KEY
                },
                body: JSON.stringify(updatedAssetsArray)
            });
            let result = await res.json();
            if (result && result.record) {
                ALL_ASSETS = updatedAssetsArray;
                populateTypeFilter();
                renderAssets(
                    document.getElementById("searchInput").value,
                    document.getElementById("typeFilter").value,
                    document.getElementById("statusFilter").value
                );
            } else {
                alert("Update failed: " + (result.message || JSON.stringify(result)));
            }
        } catch (e) {
            alert("Update error: " + e);
        }
    }
    
    function showForm(asset = {}, editingIdx = null) {
      const modal = document.getElementById("formModal");
      const formCard = document.getElementById("formCard");
      const isEditing = typeof editingIdx === "number";
      modal.classList.add("show");
      formCard.innerHTML = `
        <form id="assetForm" autocomplete="off">
          <input type="text" name="Name" required placeholder="Asset Name" value="${asset.Name||""}" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
          <select name="Type" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">${ASSET_TYPES.map(t =>
            `<option ${t===(asset.Type||ASSET_TYPES[0]) ? "selected":""}>${t}</option>`
          ).join("")}</select>
          <div style="display:flex;gap:8px;">
            <input type="text" style="flex:1;" id="serialInput" name="Serial" required placeholder="Serial Number" value="${asset.Serial||""}" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
            <button type="button" class="btn scan" id="scanBarcodeBtn" title="Scan barcode">Scan</button>
          </div>
          <select name="Area" required style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
            <option value="" disabled ${asset.Area ? "" : "selected"}>Select Area</option>
            ${AREA_OPTIONS.map(opt => `<option value="${opt}" ${asset.Area === opt ? "selected" : ""}>${opt}</option>`).join("")}
          </select>
          <input type="text" name="Assigned" placeholder="Assigned To" value="${asset.Assigned||""}" style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
          <textarea name="Notes" placeholder="Notes" style="min-height:48px; background: #0a0e1a88; border: 2px solid var(--neon-blue);">${asset.Notes||""}</textarea>
          <div style="display:flex; flex-wrap:wrap; gap:15px; margin-top:6px;">
              <label style="display:flex; align-items:center; color: var(--neon-pink);">
                <input type="checkbox" name="Faulty" ${asset.Faulty ? "checked" : ""} style="margin-right:8px;">
                Faulty
              </label>
              <label style="display:flex; align-items:center; color: var(--neon-pink);">
                <input type="checkbox" name="Reserved" ${asset.Reserved ? "checked" : ""} style="margin-right:8px;">
                Reserved
              </label>
          </div>
          ${!isEditing ? `
          <div class="quantity-input-group">
            <label for="quantityInput" style="color: var(--neon-pink);">Quantity:</label>
            <input type="number" id="quantityInput" name="quantity" min="1" value="1" required style="background: #0a0e1a88; border: 2px solid var(--neon-blue);">
          </div>
          ` : ''}
          <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:12px;">
            <button class="btn" type="submit" style="flex:1;">${isEditing ? 'Update' : 'Add'} Asset</button>
            <button class="btn cancel" type="button" id="cancelBtn" style="flex:1;">Cancel</button>
          </div>
        </form>
        <div id="scanner-modal-root"></div>
      `;
      document.getElementById("assetForm").onsubmit = function(e) {
        e.preventDefault();
        const form = e.target;
        const formData = Object.fromEntries(new FormData(form));
        const newAsset = {
          ...formData,
          Faulty: form.Faulty.checked,
          Reserved: form.Reserved.checked
        };
        const quantityToAdd = isEditing ? 1 : parseInt(form.quantity?.value, 10) || 1;
        saveAsset(newAsset, editingIdx, quantityToAdd);
        modal.classList.remove("show");
      };
      document.getElementById("cancelBtn").onclick = function() {
        modal.classList.remove("show");
      };
      document.getElementById("scanBarcodeBtn").onclick = function() {
        openBarcodeScanner(document.getElementById("serialInput"));
      };
    }
    
    function openBarcodeScanner(inputElem) {
      let modal = document.createElement("div");
      modal.id = "scanner-container";
      modal.innerHTML = `
        <div>
          <video id="barcodeVideo" autoplay></video>
          <div id="scanner-status">Initializing camera...</div>
          <button id="scanner-close">Cancel</button>
        </div>
      `;
      document.body.appendChild(modal);
      let codeReader = new ZXing.BrowserMultiFormatReader();
      let videoElem = modal.querySelector("#barcodeVideo");
      let statusElem = modal.querySelector("#scanner-status");
      let closeBtn = modal.querySelector("#scanner-close");
      let stopScan = () => {
        codeReader.reset();
        if (modal.parentNode) modal.parentNode.removeChild(modal);
      };
      closeBtn.onclick = stopScan;
      codeReader
        .listVideoInputDevices()
        .then(videoInputDevices => {
          let backCam = videoInputDevices.find(
            d => /back|rear|environment/i.test(d.label)
          );
          let deviceId = backCam ? backCam.deviceId : videoInputDevices[0]?.deviceId;
          if (!deviceId && videoInputDevices.length) deviceId = videoInputDevices[0].deviceId;
          if (!deviceId) {
            statusElem.textContent = "No camera found!";
            return;
          }
          codeReader.decodeFromVideoDevice(deviceId, videoElem, (result, err) => {
            if (result) {
              inputElem.value = result.text;
              statusElem.textContent = "Scanned: " + result.text;
              setTimeout(stopScan, 900);
            } else if (err && !(err instanceof ZXing.NotFoundException)) {
              statusElem.textContent = "Error: " + err;
            }
          });
        })
        .catch(e => {
          statusElem.textContent = "Camera error: " + e;
        });
    }
    
    function editSingleAsset(globalIndex) {
        if (globalIndex >= 0 && globalIndex < ALL_ASSETS.length) {
            const assetToEdit = ALL_ASSETS[globalIndex];
            showForm(assetToEdit, globalIndex);
        } else {
            alert("Error: Invalid asset index.");
        }
    }
    
    function showTypeManagement() {
      const modal = document.getElementById("typesModal");
      const card = document.getElementById("typesCard");
      modal.classList.add("show");
      
      let html = `
        <h3 style="margin-top:0; text-align:center; text-shadow: 0 0 10px var(--neon-blue);">Manage Asset Types</h3>
        <div id="typesList" style="max-height: 60vh; overflow-y: auto; margin-bottom: 20px;">
          ${ASSET_TYPES.map((type, index) => `
            <div class="type-item" data-index="${index}">
              <input type="text" class="type-input" value="${type}" data-original="${type}">
              <div class="type-actions">
                <button class="btn type-btn update-type" title="Update Type">💾</button>
                <button class="btn delete type-btn delete-type" title="Delete Type">🗑️</button>
              </div>
            </div>
          `).join('')}
        </div>
        <div style="display:flex; gap:12px; justify-content:flex-end;">
          <button class="btn" id="addTypeField" style="flex:1;">Add New Type</button>
          <button class="btn cancel" id="closeTypesModal" style="flex:1;">Close</button>
        </div>
      `;
      
      card.innerHTML = html;
      
      document.querySelectorAll('.update-type').forEach(btn => {
        btn.addEventListener('click', function() {
          const item = this.closest('.type-item');
          const index = parseInt(item.dataset.index);
          const input = item.querySelector('.type-input');
          const newName = input.value.trim();
          const originalName = input.dataset.original;
          
          if (!newName) {
            alert("Type name cannot be empty!");
            return;
          }
          
          if (newName !== originalName) {
            if (ASSET_TYPES.includes(newName)) {
              alert(`Asset type "${newName}" already exists!`);
              return;
            }
            
            ASSET_TYPES[index] = newName;
            input.dataset.original = newName;
            
            ALL_ASSETS.forEach(asset => {
              if (asset.Type === originalName) {
                asset.Type = newName;
              }
            });
            
            saveUpdatedAssets(ALL_ASSETS);
            alert(`Asset type updated from "${originalName}" to "${newName}"`);
          }
        });
      });
      
      document.querySelectorAll('.delete-type').forEach(btn => {
        btn.addEventListener('click', function() {
          const item = this.closest('.type-item');
          const index = parseInt(item.dataset.index);
          const typeName = ASSET_TYPES[index];
          
          const assetsUsingType = ALL_ASSETS.filter(a => a.Type === typeName);
          
          if (assetsUsingType.length > 0) {
            if (!confirm(`There are ${assetsUsingType.length} assets using the type "${typeName}". Deleting this type will reset these assets to "Other". Continue?`)) {
              return;
            }
            
            assetsUsingType.forEach(asset => {
              asset.Type = "Other";
            });
          }
          
          ASSET_TYPES.splice(index, 1);
          
          saveUpdatedAssets(ALL_ASSETS);
          showTypeManagement();
        });
      });
      
      document.getElementById("addTypeField").addEventListener('click', function() {
        const newList = document.getElementById("typesList");
        const newIndex = ASSET_TYPES.length;
        const newItem = document.createElement('div');
        newItem.className = 'type-item';
        newItem.dataset.index = newIndex;
        newItem.innerHTML = `
          <input type="text" class="type-input" placeholder="New type name" data-original="">
          <div class="type-actions">
            <button class="btn type-btn update-type" title="Add Type">💾</button>
            <button class="btn delete type-btn delete-type" title="Delete Type">🗑️</button>
          </div>
        `;
        newList.appendChild(newItem);
        
        newItem.querySelector('.update-type').addEventListener('click', function() {
          const input = newItem.querySelector('.type-input');
          const newName = input.value.trim();
          
          if (!newName) {
            alert("Type name cannot be empty!");
            return;
          }
          
          if (ASSET_TYPES.includes(newName)) {
            alert(`Asset type "${newName}" already exists!`);
            return;
          }
          
          ASSET_TYPES.push(newName);
          input.dataset.original = newName;
          
          saveUpdatedAssets(ALL_ASSETS);
          showTypeManagement();
        });
        
        newItem.querySelector('.delete-type').addEventListener('click', function() {
          newItem.remove();
        });
        
        newItem.querySelector('.type-input').focus();
      });
      
      document.getElementById("closeTypesModal").addEventListener('click', function() {
        modal.classList.remove("show");
      });
    }
    
    window.editAssetGroup = showGroupEditForm;
    window.editSingleAsset = editSingleAsset;
    window.deleteAssetGroup = deleteAssetGroup;
    
    document.getElementById("exportBtn").onclick = function() {
      if (!ALL_ASSETS.length) return alert("No assets to export.");
      const csv = [
        ["Name","Type","Serial","Area","Assigned","Notes","Faulty","Reserved"].join(","),
        ...ALL_ASSETS.map(a =>
          [a.Name, a.Type, a.Serial, a.Area, a.Assigned, a.Notes, a.Faulty ? "Yes" : "No", a.Reserved ? "Yes" : "No"]
            .map(x => `"${(x || "").replace(/"/g, '""')}"`).join(",")
        )
      ].join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "Superb_IT_Assets.csv";
      a.click();
      URL.revokeObjectURL(url);
    };
    
    document.getElementById("pdfBtn").onclick = function() {
      const counts = getTypeCounts();
      const doc = new window.jspdf.jsPDF();
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.setTextColor(0, 240, 255);
      doc.text("Asset Types & Quantities", 14, 18);
      doc.setFontSize(12);
      doc.setTextColor(255, 255, 255);
      let y = 32;
      Object.keys(counts).sort().forEach((type, idx) => {
        doc.text(`${type}:`, 22, y + idx * 9);
        doc.text(`${counts[type]}`, 132, y + idx * 9, {align:'right'});
      });
      doc.setFontSize(11);
      doc.text(`Total assets: ${ALL_ASSETS.length}`, 14, y + Object.keys(counts).length * 9 + 10);
      doc.save("Asset_Types_Quantities.pdf");
    };
    
    document.getElementById("addFab").onclick = function() { showForm(); };
    document.getElementById("manageTypesBtn").onclick = showTypeManagement;
    
    document.getElementById("searchInput").oninput = function(e) {
      renderAssets(e.target.value, document.getElementById("typeFilter").value, document.getElementById("statusFilter").value);
    };
    
    document.getElementById("typeFilter").onchange = function(e) {
      CURRENT_TYPE = e.target.value;
      renderAssets(document.getElementById("searchInput").value, document.getElementById("typeFilter").value, document.getElementById("statusFilter").value);
    };
    
    document.getElementById("statusFilter").onchange = function(e) {
      renderAssets(document.getElementById("searchInput").value, document.getElementById("typeFilter").value, e.target.value);
    };
    
    setTimeout(fetchAssets, 120);
    window.onresize = function() {
      renderAssets(document.getElementById("searchInput").value, document.getElementById("typeFilter").value, document.getElementById("statusFilter").value);
    };
  </script>
</body>
</html>